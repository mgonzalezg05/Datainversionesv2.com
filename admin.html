
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Datainversiones</title>
    <link rel="stylesheet" href="assets/app.css">
  <meta name="robots" content="noindex,nofollow" />
</head>
<body>

    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Panel de Administracion</h1>
            <a href="index.html" class="btn secondary">Ver Home</a>
        </header>

    <div id="admin-panel">
        <div class="card">
                <h2 id="form-title">Agregar Nuevo Bono</h2>
                <form id="bond-form">
                    <input type="hidden" name="id">
                    <div>
                        <label for="ticker">Ticker</label>
                        <input type="text" name="ticker" required>
                    </div>
                    <div>
                        <label for="tipo">Tipo</label>
                        <select name="tipo">
                            <option value="LECAP">LECAP</option>
                            <option value="BONO_FIJO">BONO_FIJO</option>
                        </select>
                    </div>
                    <div>
                        <label for="vencimiento">Vencimiento</label>
                        <input type="date" name="vencimiento" required>
                    </div>
                    <div>
                        <label for="valor_nominal">Valor Nominal</label>
                        <input type="number" name="valor_nominal" step="0.01" required>
                    </div>
                    <div>
                        <label for="precio_limpio">Precio Limpio</label>
                        <input type="number" name="precio_limpio" step="0.01" required>
                    </div>
                    <div>
                        <label for="interes_devengado">Interes Devengado</label>
                        <input type="number" name="interes_devengado" step="0.01" required>
                    </div>
                    <div>
                        <label for="comision_bp">Comision (bp)</label>
                        <input type="number" name="comision_bp" step="1" required>
                    </div>
                    <div>
                        <label for="fecha_liquidacion">Fecha Liquidacion</label>
                        <input type="date" name="fecha_liquidacion" required>
                    </div>
                     <div>
                        <label for="fuente_cotizacion">Fuente</label>
                        <select name="fuente_cotizacion">
                            <option value="manual">manual</option>
                            <option value="api">api</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit">Guardar Bono</button>
                        <button type="button" id="cancel-edit" class="btn secondary hidden">Cancelar Edicion</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>Bonos Existentes</h2>
                <div class="controls">
                    <button id="import-btn" class="btn">Importar JSON</button>
                    <input type="file" id="import-input" accept=".json" class="hidden">
                    <button id="export-btn" class="btn secondary">Exportar JSON</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="admin-bonds-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Tipo</th>
                                <th>Vencimiento</th>
                                <th>Precio Limpio</th>
                                <th>Comision (bp)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-bonds-table-body">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>LECAPs - Cargar datos (JSON)</h2>
            <p>Solo administradores. Este JSON reemplaza los datos locales usados por la pagina LECAPs (beta).</p>
            <div class="controls">
                <input type="file" id="lecaps-import-input" accept="application/json" />
                <button class="btn secondary" id="lecaps-clear">Borrar LECAPs local</button>
            </div>
            <div id="lecaps-status" class="mt-2" style="font-size:14px;color:#555;">Sin datos locales de LECAPs.</div>
            <div id="lecaps-errors" class="hidden" style="margin-top:8px;color:#b91c1c;background:#fee2e2;padding:8px;border-radius:6px;"></div>
        </div>
    </div>

  <script src="assets/app.js"></script>
  <script>
    // LECAPs admin: carga JSON y estado
    (function(){
      const S = {
        import: document.getElementById('lecaps-import-input'),
        status: document.getElementById('lecaps-status'),
        errors: document.getElementById('lecaps-errors'),
        clear: document.getElementById('lecaps-clear')
      };
      function sanitize(raw){
        try{ const d = JSON.parse(JSON.stringify(raw)); const num=v=> (typeof v==='string'&&v.trim()!==''?Number(v):v);
          d.params = d.params||{}; d.params.t_plus=num(d.params.t_plus); d.params.comision_pct=num(d.params.comision_pct); d.params.dm_pct=num(d.params.dm_pct); d.params.dm_monto=num(d.params.dm_monto);
          (d.items||[]).forEach(it=>{ it.tem=num(it.tem); it.precios=it.precios||{}; it.precios.ultimo=num(it.precios.ultimo); it.precios.compra=num(it.precios.compra); it.precios.cierre=num(it.precios.cierre);
            it.overrides=it.overrides||{}; it.overrides.comision_pct=num(it.overrides.comision_pct); it.overrides.dm_pct=num(it.overrides.dm_pct); it.overrides.dm_monto=num(it.overrides.dm_monto); it.overrides.t_plus=(it.overrides.t_plus===''?null:num(it.overrides.t_plus)); });
          return d; } catch { return raw; }
      }
      function validate(d){ const errs=[]; if(!d||typeof d!=='object') errs.push('Raiz debe ser objeto'); if(!d.version) errs.push('Falta version'); if(!d.updated_at) errs.push('Falta updated_at'); if(!Array.isArray(d.items)) errs.push('items debe ser lista'); (d.items||[]).forEach((it,i)=>{ ['ticker','emision','vencimiento','tem'].forEach(k=>{ if(it[k]==null) errs.push(`item[${i}].${k} requerido`); }); }); return {ok:errs.length===0, errors:errs}; }
      function updateStatus(){ const raw = localStorage.getItem('lecapsData'); if(!raw){ S.status.textContent='Sin datos locales de LECAPs.'; return; } try{ const data=JSON.parse(raw); const v=validate(data); if(v.ok){ S.status.textContent=`LECAPs local cargado: version=${data.version||'-'}, items=${(data.items||[]).length}`; S.errors.classList.add('hidden'); S.errors.textContent=''; } else { S.status.textContent='LECAPs local invalido.'; S.errors.classList.remove('hidden'); S.errors.innerHTML=v.errors.map(e=>'- '+e).join('<br>'); } } catch{ S.status.textContent='LECAPs local corrupto.'; } }
      updateStatus();
      if(S.import){ S.import.addEventListener('change',(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ const data=sanitize(JSON.parse(rd.result)); const v=validate(data); if(!v.ok){ S.errors.classList.remove('hidden'); S.errors.innerHTML=v.errors.map(e=>'- '+e).join('<br>'); return; } localStorage.setItem('lecapsData', JSON.stringify(data)); updateStatus(); alert('LECAPs cargado. Abrir pages/lecaps-beta.html para ver los cambios.'); }catch(err){ S.errors.classList.remove('hidden'); S.errors.textContent='JSON invalido: '+err.message; } }; rd.readAsText(f); }); }
      if(S.clear){ S.clear.addEventListener('click', ()=>{ localStorage.removeItem('lecapsData'); updateStatus(); }); }
    })();
  </script>
</body>
</html>




